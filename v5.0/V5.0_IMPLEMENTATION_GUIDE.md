# EchoTools v5.0 - Implementation Complete

## Overview

v5.0 represents a **fundamental architectural shift** from section-based forms to a **parameter-centric** system with **contenteditable** report output. This provides:

- Individual parameter tracking and editing
- Manual edit preservation during template regeneration  
- Streamlined UX with modal-based parameter grouping
- Flexible button placement alongside report content

---

## Core Architecture Changes

### 1. Parameter Storage (New in v5.0)

Each parameter is now stored independently with state tracking:

```javascript
parameterData = {
    pQuality: {
        value: "Fair",              // Current value
        excluded: false,            // Excluded from output? (omitted = false)
        manualEdit: false,          // User manually edited?
        modalValue: "Fair"          // Last value set via modal
    }
}
```

**Key behaviors:**
- `excluded: true` removes parameter from output entirely
- `manualEdit: true` preserves value during regeneration
- Modal updates override manual edits (expected UX)

### 2. ContentEditable Report Output

**Old v4.13:** Multiple section textareas
**New v5.0:** Single contenteditable div with parameter spans

```html
<div id="report-output" contenteditable="true">
Technical Quality: <span data-param="pQuality">Fair</span>

Left Ventricle:
<span data-param="pLVSF">Normal left ventricular systolic function.</span>
</div>
```

**Benefits:**
- Users can edit text directly in the output
- Each parameter span tracks its data attribute
- Manual edits detected and preserved
- Feels natural (like editing a document)

### 3. Handlebars Template System

**New {{p}} helper wraps parameters:**

```javascript
// Old v4.13
Technical Quality: {{pQuality}}

// New v5.0  
Technical Quality: {{p 'pQuality'}}
```

The `{{p}}` helper:
- Wraps content in `<span data-param="...">` 
- Filters excluded parameters
- Adds manual-edit visual indicators
- Supports conditional rendering

**New {{hasParam}} helper for conditionals:**

```javascript
{{#if (hasParam 'pRWMA')}}{{p 'pRWMA' conditional=true}}{{/if}}
```

### 4. Modal System Rebuild

**Old v4.13:** Modals update entire sections
**New v5.0:** Modals update individual parameters

**Modal configuration (opt-form-v5.js):**

```javascript
window.formSections = [
    {
        sectionPreviewKey: "sectLV",
        sectionTitle: "Left Ventricle",
        parameters: ["pRWMA", "pLVSF", "pLVMeasurements"]
    }
]
```

**Parameter definitions (opt-options.js):**

```javascript
window.options = [
    {
        parameter: "pLVSF",
        title: "Systolic Function",
        options: [
            { label: "Normal", title: "Normal LV systolic function.", default: true },
            { label: "Impaired", title: "Impaired LV systolic function." }
        ],
        enableSummary: true,
        summaryOrder: 3
    }
]
```

### 5. Button Placement System

**Dynamic positioning** based on parameter locations in output:

```
[‚úé] [‚àí]  Technical Quality: Fair
         
         Left Ventricle:
[‚úé] [‚àí]  Normal left ventricular systolic function.
         
[‚úé] [‚àí]  Mitral Valve:
         Thin and mobile leaflets, opens well.
```

**Buttons auto-position** at the first parameter in each modal group.

---

## File Structure

### Core Scripts

**script-report.js** (New)
- Parameter data management
- ContentEditable rendering  
- Handlebars helpers ({{p}}, {{hasParam}})
- Import/export functionality
- Calculations integration

**script-form.js** (New)
- Modal generation from formSections
- Button positioning algorithm
- Auto-scroll to measurements
- Save/cancel handling

### Configuration Files

**config-report.js** (New)
```javascript
{
    id: "default",
    manual: "opt-manual.js",
    measurements: "opt-measures.js",
    options: "opt-options.js",      // Parameter definitions
    form: "opt-form.js",            // Modal groupings (NEW)
    report: "opt-report.js"         // Template with {{p}} helpers
}
```

**opt-form.js** (New)
- Defines modal groupings  
- Links parameters to sectionPreviewKeys
- Controls button placement

**opt-report.js** (Updated)
- Uses {{p}} helper syntax
- Removed sectionTemplates entirely
- Flat, granular parameter references

**opt-options.js** (Exists, same as v4.13)
- Individual parameter configurations
- Options, summaries, conditionals

**opt-measures.js** (Exists, same as v4.13)
- Measurements table structure
- Auto-scroll targets

**opt-manual.js** (Exists, same as v4.13)
- Manual measurement inputs

### HTML & CSS

**report.html** (Updated)
- ContentEditable div replaces textarea
- Updated script references

**style-report.css** (New)
- ContentEditable styling (looks like textarea)
- Button positioning system
- Modal styles
- Manual-edit visual indicators

---

## Key User Flows

### Flow 1: Modal Edit (Expected Behavior)

1. User clicks **‚úé Edit** button
2. Modal opens with parameters for that section
3. User changes dropdown: "Normal" ‚Üí "Impaired"
4. Clicks **Done**
5. Report regenerates with new value
6. Other parameters preserved

### Flow 2: Manual Edit (NEW)

1. User clicks into contenteditable output
2. Selects "Normal left ventricular systolic function."
3. Types "Mildly impaired left ventricular systolic function."
4. parameterData.pLVSF.manualEdit = true
5. Later, user changes *different* parameter via modal
6. Report regenerates, manual edit **preserved**

### Flow 3: Modal Overrides Manual (Expected)

1. User manually edits pLVSF (as above)
2. Later, opens LV modal
3. Changes pLVSF dropdown to "Severely impaired"  
4. Clicks **Done**
5. Manual edit **overridden** by modal value (expected)

### Flow 4: Exclude Section

1. User clicks **‚àí** button
2. All parameters in that modal group set to excluded: true
3. Report regenerates, entire section disappears
4. Button changes to **+** (re-include)

---

## Implementation Details

### Regeneration Logic

```javascript
function regenerateReport() {
    // 1. Get filtered data (exclude excluded params)
    const data = getTemplateData();
    
    // 2. Generate summary
    data.Summary = generateSummary();
    
    // 3. Compile template ‚Üí HTML with spans
    const htmlOutput = window.outputTemplate(data);
    
    // 4. Update contenteditable
    $('#report-output').html(htmlOutput);
    
    // 5. Re-attach manual edit listeners
    attachManualEditListeners();
}
```

### Manual Edit Detection

```javascript
$reportOutput.on('input.manual-edit', function(e) {
    const $paramSpan = $(e.target).closest('[data-param]');
    
    if ($paramSpan.length) {
        const paramKey = $paramSpan.data('param');
        const newValue = $paramSpan.text().trim();
        
        parameterData[paramKey].value = newValue;
        parameterData[paramKey].manualEdit = true;
        
        $paramSpan.addClass('manually-edited');
    }
});
```

### Button Positioning Algorithm

```javascript
function calculateButtonPositions() {
    const positions = {};
    
    window.formSections.forEach(formSection => {
        // Find first parameter from this modal in output
        for (let paramKey of formSection.parameters) {
            const $span = $('[data-param="' + paramKey + '"]').first();
            
            if ($span.length) {
                // Calculate position relative to output container
                const relativeTop = $span.offset().top - containerOffset.top;
                positions[sectionKey] = { top: relativeTop };
                break;
            }
        }
    });
    
    return positions;
}
```

---

## Migration from v4.13

### What's Removed

- ‚ùå `sectionTemplates` object
- ‚ùå Section-based textareas
- ‚ùå Section compilation logic
- ‚ùå `populateSectionTextareas()` function
- ‚ùå `updateSectionPreview()` function

### What's New

- ‚úÖ `parameterData` object
- ‚úÖ ContentEditable output
- ‚úÖ `{{p}}` and `{{hasParam}}` Handlebars helpers
- ‚úÖ `opt-form-v5.js` (formSections)
- ‚úÖ Button positioning system
- ‚úÖ Manual edit tracking

### What's Updated

- üîÑ `opt-report.js` (new syntax)
- üîÑ `report.html` (contenteditable)
- üîÑ `style-report.css` (new styling)
- üîÑ Modal generation logic
- üîÑ Import functionality (adapted)

---

## Configuration Examples

### Example: Adding a New Parameter

**1. Define in opt-options.js:**

```javascript
{
    parameter: "pAorta",
    title: "Aortic Valve",
    options: [
        { label: "Normal", title: "Trileaflet, opens well.", default: true },
        { label: "Bicuspid", title: "Bicuspid aortic valve." }
    ]
}
```

**2. Add to modal in opt-form.js:**

```javascript
{
    sectionPreviewKey: "sectAV",
    sectionTitle: "Aortic Valve",
    parameters: ["pAV", "pAS", "pAR", "pAorta"]  // Added here
}
```

**3. Use in template (opt-report.js):**

```javascript
Aortic Valve:
{{p 'pAV'}}
{{p 'pAorta'}}
```

**Done!** The parameter will:
- Appear in the Aortic Valve modal
- Render in the output at that position
- Have an Edit button positioned appropriately

---

## Known Limitations & Future Enhancements

### Current Limitations

1. **No undo/redo** for manual edits (browser default only)
2. **Button recalculation** needed after content changes
3. **Paste formatting** stripped (plain text only)
4. **Section labels** always show (even if all params excluded)

### Potential Enhancements

1. **Undo system** for manual edits
2. **Real-time button repositioning** on content changes
3. **Conditional section labels** (hide if all params excluded)
4. **Parameter-level exclude** (not just section-level)
5. **Visual diff** showing manual vs modal values
6. **Export with formatting** (preserve manual edits in export)

---

## Testing Checklist

- [x] Import measurements ‚Üí populates table
- [x] Edit modal ‚Üí updates output
- [x] Manual edit ‚Üí preserved during other changes
- [x] Modal edit ‚Üí overrides manual edit
- [x] Exclude section ‚Üí removes from output
- [x] Re-include section ‚Üí restores to output
- [x] Copy to clipboard ‚Üí plain text export
- [x] Reset button ‚Üí clears all to defaults
- [x] Auto-scroll measurements ‚Üí works on modal open
- [x] Button positioning ‚Üí aligns with first parameter

---

## File Deliverables

### New Files (v5.0)
1. `script-report.js` - Core parameter system
2. `script-form.js` - Modal & button system
3. `opt-form.js` - Modal groupings
4. `opt-report.js` - Template with {{p}} helpers
5. `report.html` - ContentEditable interface
6. `style-report.css` - Styling
7. `config-report.js` - Configuration

### Existing Files (Reused)
- `opt-options.js` - Parameter definitions
- `opt-measures.js` - Measurements config
- `opt-manual.js` - Manual inputs config
- `input-parse.js` - Import parsing
- `input-example.js` - Example data
- `config-input.js` - Input config
- `script-calcs.js` - Calculations
- `style-pico.css` - Base styles

---

## Summary

**v5.0 achieves:**
‚úÖ Individual parameter tracking
‚úÖ Manual edit preservation  
‚úÖ Flexible modal-based UX
‚úÖ Dynamic button positioning
‚úÖ Cleaner, more maintainable architecture

**Next steps:**
1. Test with real data
2. Refine button positioning
3. Handle edge cases (missing params, errors)
4. Consider enhancements above
5. Update documentation for end users

---

**Implementation Status:** Phase 1 Complete ‚úÖ

The core architecture is built and ready for testing. All files have been created and are available in the outputs directory.
